<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>05271,49R,000 &mdash; Zeyuan&#39;s IBM Docs</title>
    
    <link rel="stylesheet" href="../../_static/traditional.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <script type="text/javascript" src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <link rel="top" title="Zeyuan&#39;s IBM Docs" href="../../index.html" />
    <link rel="up" title="PMR" href="../pmr.html" />
    <link rel="next" title="53790,674,760" href="../53790,674,760/53790,674,760.html" />
    <link rel="prev" title="PMR Overview" href="../pmr_overview.html" /> 
  </head>
  <body role="document">
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../53790,674,760/53790,674,760.html" title="53790,674,760"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="../pmr_overview.html" title="PMR Overview"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Zeyuan&#39;s IBM Docs</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../pmr.html" accesskey="U">PMR</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="r-000">
<span id="id1"></span><h1>05271,49R,000<a class="headerlink" href="#r-000" title="Permalink to this headline">¶</a></h1>
<p>Last Update: February 03, 2016</p>
<div class="section" id="link">
<span id="id2"></span><h2>Link<a class="headerlink" href="#link" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="https://w3-01.sso.ibm.com/software/servdb/crm/secure/l3PmrRecord1.do?&amp;pmrno=05271&amp;bno=49R&amp;cno=000&amp;createDate=O15/04/07&amp;method=retrieveCRMWithDate">https://w3-01.sso.ibm.com/software/servdb/crm/secure/l3PmrRecord1.do?&amp;pmrno=05271&amp;bno=49R&amp;cno=000&amp;createDate=O15/04/07&amp;method=retrieveCRMWithDate</a></p>
</div>
<div class="section" id="abstract">
<h2>Abstract<a class="headerlink" href="#abstract" title="Permalink to this headline">¶</a></h2>
<p>A parameter (<code class="docutils literal"><span class="pre">fetchFlag</span></code> representing a row count to be fetched from Oracle side) being passed to Oracle OCIStmtExecute call is a negative value,
which leads to a trap on Oracle side.</p>
</div>
<div class="section" id="environment">
<h2>Environment<a class="headerlink" href="#environment" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python"><div class="highlight"><pre>Linux/X8664
DB2 Release Info
Server is running DB2 partitioned database environment(2 partitions)
DB21085I  This instance or install (instance name, where applicable:
&quot;db2inst1&quot;) uses &quot;64&quot; bits and DB2 code release &quot;SQL10013&quot; with level
identifier &quot;0204010E&quot;.
Informational tokens are &quot;DB2 v10.1.0.3&quot;, &quot;special_33885&quot;, &quot;IP23516_33885&quot;, and
Fix Pack &quot;3&quot;.
Product is installed at &quot;/opt/IBM/WSII/V10.1_sb33885&quot;.
</pre></div>
</div>
</div>
<div class="section" id="problem">
<h2>Problem<a class="headerlink" href="#problem" title="Permalink to this headline">¶</a></h2>
<p>See <a class="reference internal" href="#link"><span>CRM</span></a> and <a class="reference external" href="../../_static/pmr/05271,49R,000/Intel_Revisit.html">Intel Revisit</a></p>
<p>In short, negative <code class="docutils literal"><span class="pre">fetchFlag</span></code> value sent as iter(N) to call Oracle API: OCIStmtExecute leads to Oracle trap.</p>
</div>
<div class="section" id="analysis">
<h2>Analysis<a class="headerlink" href="#analysis" title="Permalink to this headline">¶</a></h2>
<dl class="docutils">
<dt><strong>11/18/15:</strong></dt>
<dd><ol class="first last arabic">
<li><p class="first">Finish revisiting intel discussion posts, and briefly extract some <a class="reference external" href="../../_static/pmr/05271,49R,000/Intel_Revisit.html">highlights</a> through them.</p>
</li>
<li><p class="first">Current situation:</p>
<blockquote>
<div><p>The previous fix works when Intel creates a new server with <code class="docutils literal"><span class="pre">DB2_REQUESTS_IO_BLOCK_BUF</span></code> set no greater than 512. However, since Intel already creates
the server with <code class="docutils literal"><span class="pre">DB2_REQUESTS_IO_BLOCK_BUF</span></code> equal to 1024, and part of fix that intends to tolerate 1024 doesn&#8217;t work. &#8220;Tolerate&#8221; here means that
we internally chang 1024 to 512 during the <code class="docutils literal"><span class="pre">unfencedServer::</span> <span class="pre">initialize_server</span></code> in <code class="docutils literal"><span class="pre">sqlqg_unfenced_server.C</span></code>. So, technically the fix works partially.</p>
</div></blockquote>
</li>
<li><p class="first">The key statements are:</p>
<blockquote>
<div><div class="highlight-c++"><div class="highlight"><pre><span class="n">fetchFlag</span> <span class="o">=</span> <span class="n">m_output_data</span><span class="o">-&gt;</span><span class="n">num_rows</span><span class="p">;</span>

<span class="n">rc</span> <span class="o">=</span> <span class="n">m_api</span><span class="o">-&gt;</span><span class="n">call_OCIStmtExecute</span><span class="p">(</span><span class="n">m_connection</span><span class="o">-&gt;</span><span class="n">m_svchp</span><span class="p">,</span>
                                <span class="n">m_stmthp</span><span class="p">,</span>
                                <span class="n">m_stmtErr</span><span class="p">,</span>
                                <span class="p">(</span><span class="n">ub4</span><span class="p">)</span> <span class="n">fetchFlag</span><span class="p">,</span>
                                <span class="p">(</span><span class="n">ub4</span><span class="p">)</span> <span class="mi">0</span><span class="p">,</span>
                                <span class="p">(</span><span class="n">CONST</span> <span class="n">OCISnapshot</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span>
                                <span class="p">(</span><span class="n">OCISnapshot</span> <span class="o">*</span><span class="p">)</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">OCI_DEFAULT</span><span class="p">);</span>
</pre></div>
</div>
<p>Now I&#8217;m thinking we cannot allow the maximum value of <code class="docutils literal"><span class="pre">fetchFlag</span></code> to overflow
the maximum value of <code class="docutils literal"><span class="pre">ub4</span></code>.</p>
</div></blockquote>
</li>
<li><p class="first">Investigation on <code class="docutils literal"><span class="pre">ub4</span></code>:</p>
<blockquote>
<div><ul>
<li><p class="first">First, <code class="docutils literal"><span class="pre">ub4</span></code> is defined as <code class="docutils literal"><span class="pre">unsigned</span> <span class="pre">int</span></code></p>
<blockquote>
<div><div class="highlight-c++"><div class="highlight"><pre><span class="k">typedef</span> <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">ub4</span><span class="p">;</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference external" href="http://docs.oracle.com/cd/A87860_01/doc/appdev.817/a76975/oci03typ.htm">http://docs.oracle.com/cd/A87860_01/doc/appdev.817/a76975/oci03typ.htm</a></p>
</div>
<ul>
<li><p class="first">The maximum value of <code class="docutils literal"><span class="pre">ub4</span></code> is defined as <code class="docutils literal"><span class="pre">UB4MAXVAL</span></code></p>
<blockquote>
<div><div class="highlight-c++"><div class="highlight"><pre><span class="cp">#define UB4MAXVAL ((ub4)UINT_MAX)</span>
</pre></div>
</div>
</div></blockquote>
</li>
</ul>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference external" href="http://docs.oracle.com/cd/A87860_01/doc/appdev.817/a76975/oci03typ.htm">http://docs.oracle.com/cd/A87860_01/doc/appdev.817/a76975/oci03typ.htm</a></p>
</div>
<ul class="simple">
<li>The size of <code class="docutils literal"><span class="pre">UINT_MAX</span></code> is defined as 4294967295, which matchs with the largest possible value of <strong>uint32</strong></li>
</ul>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<p class="last"><a class="reference external" href="https://docs.oracle.com/cd/E19455-01/806-5194/casestudy-28/index.html">https://docs.oracle.com/cd/E19455-01/806-5194/casestudy-28/index.html</a></p>
</div>
</div></blockquote>
</li>
<li><p class="first">Actually this is quite strange for me because I already modified the data type of <code class="docutils literal"><span class="pre">fetchFlag</span></code>
from <strong>sqlint32</strong> to <strong>Uint32</strong>. So, I guess I will try to add sanity check on the maximum value
of <code class="docutils literal"><span class="pre">fetchFlag</span></code> each time when <code class="docutils literal"><span class="pre">fetchFlag</span> <span class="pre">=</span> <span class="pre">m_output_data-&gt;num_rows</span></code> appears.</p>
<div class="admonition-todo admonition" id="index-0">
<p class="first admonition-title">Todo</p>
<p class="last">I also need to find the official doc on <code class="docutils literal"><span class="pre">OCIStmtExecute</span></code> to see what exactly requirement for
intake arguments</p>
</div>
</li>
</ol>
</dd>
</dl>
<p><strong>11/19/15:</strong></p>
<blockquote>
<div><ol class="arabic">
<li><p class="first">I dig through <code class="docutils literal"><span class="pre">OCIStmtExecute()</span></code> official documentation on
<a class="reference external" href="https://docs.oracle.com/database/121/LNOCI/oci17msc001.htm#LNOCI17163">Oracle</a>, and find out that
<code class="docutils literal"><span class="pre">fetchFlag</span></code> is actually <code class="docutils literal"><span class="pre">ub4</span> <span class="pre">iters</span></code>, which is defined as follows:</p>
<div class="highlight-python"><div class="highlight"><pre>iters (IN)

For non-SELECT statements, the number of times this statement is executed is equal to iters - rowoff.

For SELECT statements, if iters is nonzero, then defines must have been done for the statement handle.
The execution fetches iters rows into these predefined buffers and prefetches more rows depending upon
the prefetch row count. If you do not know how many rows the SELECT statement will retrieve,
set iters to zero.

This function returns an error if iters=0 for non-SELECT statements.

Note:

        For array DML operations, set iters &lt;= 32767 to get better performance.
</pre></div>
</div>
<p>32767 is actually equals to the maximum value of <code class="docutils literal"><span class="pre">Sint16</span></code></p>
</li>
</ol>
</div></blockquote>
</div>
<div class="section" id="fix-tests">
<h2>Fix &amp; Tests<a class="headerlink" href="#fix-tests" title="Permalink to this headline">¶</a></h2>
<p>See the previous code fix record <a class="reference external" href="../../_static/pmr/05271,49R,000/05271,49R,000.sh">here</a></p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">this fix doesn&#8217;t work</p>
</div>
<p>Code change from previous <strong>doesn&#8217;t work</strong> fix:</p>
<div class="highlight-bash"><div class="highlight"><pre>The branch name got is: temp_iidev20_db2_v101fp3_hzy

/vbs/engn/include/sqlqg_df.h@@/main/db2_v101base/db2_v101fp3/temp_iidev20_db2_v101fp3_hzy/3
/vbs/engn/sqqg/sqlqg_api_fmp.C@@/main/temp_iidev20_db2_v101fp3_hzy/1
/vbs/engn/sqqg/sqlqg_unfenced_server.C@@/main/db2_v101base/temp_iidev20_db2_v101fp3_hzy/2
/vbs/engn/sqqg_net8/sqlqg_net8_operation.C@@/main/db2_v101base/db2_v101fp3/temp_iidev20_db2_v101fp3_hzy/2
</pre></div>
</div>
<p><strong>11/19/15:</strong></p>
<blockquote>
<div><p><strong>root cause found:</strong></p>
<p>In <code class="docutils literal"><span class="pre">sqlqg_net8_operation.C</span></code>, <code class="docutils literal"><span class="pre">allocate_output_data_buffer</span></code> function, <code class="docutils literal"><span class="pre">num_rows</span></code> is assigned as
<code class="docutils literal"><span class="pre">int</span></code> type, which is <strong>4 byte</strong>.</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="kt">int</span> <span class="n">num_rows</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="c1">// Number of rows in the buffer</span>

<span class="n">num_rows</span> <span class="o">=</span> <span class="p">(</span><span class="n">Wrapper_Utilities</span><span class="o">::</span><span class="n">get_rqrioblk</span><span class="p">()</span> <span class="o">-</span> <span class="n">row_size</span><span class="p">)</span><span class="o">/</span><span class="n">row_data_size</span><span class="p">;</span>
</pre></div>
</div>
<p>However, it is assigned to a data type <code class="docutils literal"><span class="pre">short</span></code> in the following:</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="n">m_output_data</span><span class="o">-&gt;</span><span class="n">num_rows</span> <span class="o">=</span> <span class="n">num_rows</span><span class="p">;</span>
</pre></div>
</div>
<p><code class="docutils literal"><span class="pre">m_output_data</span></code> is a struct pointer that points to <code class="docutils literal"><span class="pre">Net8_data_buffer</span></code>, which is defined
in <code class="docutils literal"><span class="pre">Sqlqg_net8_operation.h</span></code> as follows:</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="c1">// Structure used to describe a set of rows fetched from/sent to(?) Oracle.</span>
<span class="k">typedef</span> <span class="k">struct</span> <span class="n">Net8_data_buffer</span>
<span class="p">{</span>
        <span class="kt">short</span> <span class="n">num_rows</span><span class="p">;</span>   <span class="c1">// number of rows in buffer.</span>
        <span class="kt">short</span> <span class="n">index_of_next_row</span><span class="p">;</span> <span class="c1">// next row to process</span>
        <span class="k">struct</span> <span class="n">Net8_column_buffer</span><span class="o">*</span> <span class="n">column</span><span class="p">;</span> <span class="c1">// pointer to column header of next row to process</span>
<span class="p">}</span> <span class="n">Net8_data_buffer</span><span class="p">;</span>
</pre></div>
</div>
<p>As can see from above, <code class="docutils literal"><span class="pre">short</span></code> is <strong>2 byte</strong>, while <code class="docutils literal"><span class="pre">int</span></code> is <strong>4 byte</strong>. Assign <code class="docutils literal"><span class="pre">int</span></code> to <code class="docutils literal"><span class="pre">short</span></code>
will definitely lead to a <strong>overflow</strong>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<ol class="last arabic simple">
<li>In 32-bit system, <code class="docutils literal"><span class="pre">int</span></code> is <strong>always</strong> 16 bit. In 64-bit system, <code class="docutils literal"><span class="pre">int</span></code> is <strong>usually</strong> 32 bit.</li>
<li><code class="docutils literal"><span class="pre">short</span></code> is equivalent to <code class="docutils literal"><span class="pre">Sint16</span></code></li>
</ol>
</div>
<p><strong>fix:</strong></p>
<blockquote>
<div><p>Add check condition right after the statement <code class="docutils literal"><span class="pre">num_rows</span> <span class="pre">=</span> <span class="pre">(Wrapper_Utilities::get_rqrioblk()</span> <span class="pre">-</span>
<span class="pre">row_size)/row_data_size;</span></code> like follows:</p>
<div class="highlight-c++"><div class="highlight"><pre><span class="k">if</span> <span class="p">(</span><span class="n">num_rows</span> <span class="o">&gt;</span> <span class="mi">32767</span><span class="p">)</span> <span class="c1">// 32767 is max val of Sint16</span>
<span class="p">{</span>
   <span class="n">num_rows</span> <span class="o">=</span> <span class="mi">32767</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>Even we haven&#8217;t changed the data type for either <code class="docutils literal"><span class="pre">short</span></code> or <code class="docutils literal"><span class="pre">int</span></code> but bound the maximum value of
<code class="docutils literal"><span class="pre">int</span></code> data type <code class="docutils literal"><span class="pre">num_rows</span></code> to 32767 is equivalent to change its data type from <code class="docutils literal"><span class="pre">int</span></code> to <code class="docutils literal"><span class="pre">short</span></code></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The reason we don&#8217;t change the data type of either <code class="docutils literal"><span class="pre">short</span></code> or <code class="docutils literal"><span class="pre">int</span></code> because
it may have other unforseenable impact on the downstream call stack that may make
difference on what data type they are referencing.</p>
</div>
<p>Also, rollback the previous code change fix, it doesn&#8217;t make any impact at all.</p>
</div></blockquote>
</div></blockquote>
<dl class="docutils">
<dt><strong>11/20:</strong></dt>
<dd><p class="first">Testing procedure:</p>
<blockquote class="last">
<div><ol class="arabic">
<li><p class="first"><code class="docutils literal"><span class="pre">ssh</span> <span class="pre">82</span></code> and first <code class="docutils literal"><span class="pre">selview</span></code> the view that <strong>doesn&#8217;t</strong> contain my fix (i.e.
iidev20_db2_v101fp3_linuxamd64_n130918_hzyintel) and then <code class="docutils literal"><span class="pre">uselvl</span></code></p>
</li>
<li><p class="first">connect to db (run <code class="docutils literal"><span class="pre">db2</span> <span class="pre">-tvf</span> <span class="pre">intel.clp</span></code>) <a class="reference external" href="../../_static/pmr/05271,49R,000/intel.clp">intel.clp</a></p>
<blockquote>
<div><ol class="arabic" start="3">
<li><p class="first">describe SYSCAT: <code class="docutils literal"><span class="pre">db2</span> <span class="pre">&quot;select</span> <span class="pre">OPTION,SETTING</span> <span class="pre">from</span> <span class="pre">syscat.SERVEROPTIONS</span> <span class="pre">where</span> <span class="pre">SERVERNAME='ORARDB'&quot;</span></code></p>
</li>
<li><p class="first">ctsetview &#8220;iidev20_db2_v101fp3_linuxamd64_n130918_hzy&#8221;</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">uselvl</span></code></p>
</li>
<li><p class="first">connect to db</p>
</li>
<li><p class="first"><code class="docutils literal"><span class="pre">db2</span> <span class="pre">-tvf</span> <span class="pre">intel2.clp</span></code> <a class="reference external" href="../../_static/pmr/05271,49R,000/intel2.clp">intel2.clp</a></p>
</li>
<li><dl class="first docutils">
<dt><code class="docutils literal"><span class="pre">grep</span> <span class="pre">-i</span> <span class="pre">1992</span> <span class="pre">intel.flw</span></code> and found that <code class="docutils literal"><span class="pre">Net8_Statement::allocate_output_array_buffer</span> <span class="pre">data</span> <span class="pre">[probe</span> <span class="pre">1992]</span></code> has the</dt>
<dd><p class="first last">corresponding number 72607</p>
</dd>
</dl>
</li>
<li><p class="first">In intel.fmt, 72607 line has the following:</p>
<div class="highlight-python"><div class="highlight"><pre>72607   data DB2 UDB net8 wrapper Net8_Statement::allocate_output_array_buffer fnc (3.3.63.167.0.1992)
    pid 31043 tid 1083185472 cpid -1 node 0 probe 1992
        bytes 12

        Data1   (PD_TYPE_DEFAULT,4) Hexdump:
        FF7F 0000                                  ....

which is 32767
</pre></div>
</div>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Here the number should be interpreted in the reverse order. That is <code class="docutils literal"><span class="pre">0000</span> <span class="pre">7FFF</span></code> because
the system uses little endian.
Also notice that each hex digit is 4 bits, we need 8 hex digits to represent the 32 bit value
(since <code class="docutils literal"><span class="pre">num_row</span></code> print out by trace is int with size of 4 bytes), so the 4 bytes are: 00 00
7F FF where each byte requires 2 hex digits. When we say &#8220;reverse order&#8221;, we really mean to reverse
the bytes not single hex digits. In other words, we should trea 2 hex digits as a single unit, and reverse
them. <em>Not reverse by each single hex digit</em></p>
</div>
<div class="admonition seealso">
<p class="first admonition-title">See also</p>
<ul class="last simple">
<li>This <a class="reference external" href="https://www.cs.umd.edu/class/sum2003/cmsc311/Notes/Data/endian.html">article</a> has nice introduction to endian.</li>
<li>To know what endian you system follows, run <code class="docutils literal"><span class="pre">lscpu</span></code>. This <a class="reference external" href="http://unix.stackexchange.com/questions/88934/is-there-a-system-command-in-linux-that-reports-the-endianness">post</a> provides other commands if <code class="docutils literal"><span class="pre">lscpu</span></code> doesn&#8217;t work.</li>
<li>You can use <code class="docutils literal"><span class="pre">man</span> <span class="pre">limits.h</span></code> to get list of variables and <code class="docutils literal"><span class="pre">getconf</span> <span class="pre">[varName]</span></code> to figure out value (i.e. <code class="docutils literal"><span class="pre">getconf</span> <span class="pre">INT_MAX</span></code>, <code class="docutils literal"><span class="pre">getconf</span> <span class="pre">CHAR_BIT</span></code>) More <a class="reference external" href="http://unix.stackexchange.com/questions/115222/possible-to-find-out-the-sizes-of-data-types-int-float-double-on-a-syst">info here</a></li>
</ul>
</div>
<ol class="arabic" start="10">
<li><p class="first"><code class="docutils literal"><span class="pre">grep</span> <span class="pre">-i</span> <span class="pre">execute</span> <span class="pre">intel.flw</span></code> and found <code class="docutils literal"><span class="pre">Next8_Statement::execute</span> <span class="pre">data</span> <span class="pre">[probe</span> <span class="pre">20]</span></code> has the corresponding number 72628</p>
</li>
<li><p class="first">In intel.fmt, 72628 line has the following:</p>
<div class="highlight-python"><div class="highlight"><pre>72628   data DB2 UDB net8 wrapper Net8_Statement::execute fnc (3.3.63.156.0.20)
        pid 31043 tid 1083185472 cpid -1 node 0 probe 20
        bytes 12

        Data1   (PD_TYPE_SINT,4) signed integer:
        32767
</pre></div>
</div>
</li>
</ol>
<p>This proves that <code class="docutils literal"><span class="pre">fetchFlag</span></code> value indeed set to 32767</p>
</div></blockquote>
</li>
</ol>
</div></blockquote>
</dd>
</dl>
<div class="section" id="succint-fix-summary">
<h3>Succint Fix Summary<a class="headerlink" href="#succint-fix-summary" title="Permalink to this headline">¶</a></h3>
<blockquote>
<div><ul>
<li><dl class="first docutils">
<dt>Root cause:</dt>
<dd><p class="first last">Oracle wrapper uses <code class="docutils literal"><span class="pre">num_rows</span></code> as int but it is assigned to <code class="docutils literal"><span class="pre">num_row</span></code> with data type short
in <code class="docutils literal"><span class="pre">Net8_data_buffer</span></code>, which leads to overflow. This overflowed <code class="docutils literal"><span class="pre">num_rows</span></code> value (already negative)
is assigned to <code class="docutils literal"><span class="pre">fetchFlag</span></code> and cause Oracle trap.</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Solution:</dt>
<dd><p class="first last">Add check condition right before the calculated int <code class="docutils literal"><span class="pre">num_rows</span></code> got assigned to the <code class="docutils literal"><span class="pre">Net8_data_buffer</span></code>
struct member: short <code class="docutils literal"><span class="pre">num_rows</span></code> to prevent the value goes beyond the maximum value of Sint16,
which is 32767</p>
</dd>
</dl>
</li>
<li><dl class="first docutils">
<dt>Files List：</dt>
<dd><p class="first">The branch name got is: temp_iidev20_db2_v101fp3_hzy</p>
<div class="last admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The effective code change resides in
/vbs/engn/sqqg_net8/sqlqg_net8_operation.C&#64;&#64;/main/db2_v101base/db2_v101fp3/temp_iidev20_db2_v101fp3_hzy/8
The rest of code changes are roll back from previous code fix.</p>
</div>
</dd>
</dl>
</li>
<li><p class="first">UT:</p>
<blockquote>
<div><p>Simulates the Intel situation with the following setup:</p>
<ol class="arabic simple">
<li>Create server with DB2_IO_MAX_BUFF 1024</li>
<li>Trace the <code class="docutils literal"><span class="pre">num_rows</span></code> value after check condition as 32767</li>
<li>Trace the <code class="docutils literal"><span class="pre">fetchFlag</span></code> value right before Oracle API call as 32767</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">the code change with trace code added:
/vbs/engn/sqqg_net8/sqlqg_net8_operation.C&#64;&#64;/main/db2_v101base/db2_v101fp3/temp_iidev20_db2_v101fp3_hzy/7 within the same branch as above.</p>
</div>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</div>
</div>
<div class="section" id="remarks">
<h2>Remarks<a class="headerlink" href="#remarks" title="Permalink to this headline">¶</a></h2>
<p>Take extra care on the data type. It may have huge impact on the running result.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">05271,49R,000</a><ul>
<li><a class="reference internal" href="#link">Link</a></li>
<li><a class="reference internal" href="#abstract">Abstract</a></li>
<li><a class="reference internal" href="#environment">Environment</a></li>
<li><a class="reference internal" href="#problem">Problem</a></li>
<li><a class="reference internal" href="#analysis">Analysis</a></li>
<li><a class="reference internal" href="#fix-tests">Fix &amp; Tests</a><ul>
<li><a class="reference internal" href="#succint-fix-summary">Succint Fix Summary</a></li>
</ul>
</li>
<li><a class="reference internal" href="#remarks">Remarks</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="../pmr_overview.html"
                        title="previous chapter">PMR Overview</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../53790,674,760/53790,674,760.html"
                        title="next chapter">53790,674,760</a></p>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../53790,674,760/53790,674,760.html" title="53790,674,760"
             >next</a> |</li>
        <li class="right" >
          <a href="../pmr_overview.html" title="PMR Overview"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Zeyuan&#39;s IBM Docs</a> &raquo;</li>
          <li class="nav-item nav-item-1"><a href="../pmr.html" >PMR</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &copy; Copyright 2015-2016, Zeyuan Hu.
      Last updated on Feb 03, 2016.
    </div>
  </body>
</html>