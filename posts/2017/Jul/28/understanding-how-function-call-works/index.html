<!DOCTYPE html>
<!--[if lt IE 7]>      <html class="no-js lt-ie9 lt-ie8 lt-ie7"> <![endif]-->
<!--[if IE 7]>         <html class="no-js lt-ie9 lt-ie8"> <![endif]-->
<!--[if IE 8]>         <html class="no-js lt-ie9"> <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js"> <!--<![endif]-->
    <head>
        <meta charset="utf-8">
        <title>    Understanding how function call works
</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta content="This is the homepage of Zeyuan (Zack) Hu" name="description">
        <meta content="Zeyuan Hu, Zeyuan, Zack Hu, zack, zeyuan hu, zeyuan ibm, IBM, Zeyuan IBM, UW Madison, University of Wisconsin Madison, zeyuan wisc, zeyuan IBM, zeyuan federation" name="keywords">
        <meta content="Zeyuan Hu" name="author">
        <link href='https://fonts.googleapis.com/css?family=Gentium+Book+Basic|Merriweather:400,300' rel='stylesheet' type='text/css'>
        <link rel="stylesheet" href="../../../../../theme/css/cid.css">
        <!-- add font-awesome -->
        <link rel="stylesheet" href="../../../../../theme/fa/css/font-awesome.min.css">
        <link href="http://zhu45.org/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Fluffy Stuff Atom Feed" />
        <link href="http://zhu45.org/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="Fluffy Stuff RSS Feed" />
        <link href="../../../../../theme/images/favicon.ico" rel="icon">
    </head>
    <body>
        <!--[if lt IE 7]>
            <p class="chromeframe">You are using an <strong>outdated</strong> browser. Please <a href="http://browsehappy.com/">upgrade your browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">activate Google Chrome Frame</a> to improve your experience.</p>
        <![endif]-->
            <div class="container">
<header class="blog-header">
    <h1 id="site-title"><a href="../../../../..">Fluffy Stuff</a></h1>
    <p> A tmp place to rest </p>
    <nav>
        <!--<a href="../../../../../zeyuan-hus-resume.html" style="padding: 10px">RESUME</a>-->
        <!-- <a href="../../../../../archives" style="padding: 10px">ARCHIVES</a> -->
            <a href="../../../../../blog2" style="padding: 10px">BLOG</a>
            <a href="../../../../../projects.html" style="padding: 10px">PROJECTS</a>
            <a href="../../../../../quotes.html" style="padding: 10px">QUOTES</a>
    </nav>
</header>
    <div class="post">
        <header>
            <h1 class="post-title">Understanding how function call works</h1>
            <div class="panel">
                <div class="panel-body">
<footer class="post-info">
    <span class="label label-default">Date</span>
    <span class="published">
        <i class="fa fa-calendar"></i><time datetime="2017-07-28T23:11:00+08:00"> Jul 28, 2017</time>
    </span>





<span class="label label-default">Tags</span>
	<a href="../../../../../tag/assembly-language.html">assembly language</a>
        /
	<a href="../../../../../tag/call-stack.html">call stack</a>
    
</footer><!-- /.post-info -->                </div>
            </div>
        </header>
        
        <article>
            <html><head></head><body><p>Understanding assembly language is crucial for system programming. Some nasty defects of the system
can only be solved by digging into the assembly level of the program. In this post, I'll revisit 
call stack concept as a way to understand how function call works under the cover of high-level language.
In addition, this post belongs to part of future work mentioned in <a href="../../../../../posts/2017/Jan/22/num-of-function-calls-in-recursive-fibonacci-routine/">my post back in January</a>.</p>
<div class="toc">
<ul>
<li><a href="#addressing-mode">Addressing mode</a></li>
<li><a href="#main-course">Main course</a><ul>
<li><a href="#some-terms">Some terms</a></li>
<li><a href="#stack">Stack</a></li>
<li><a href="#two-examples">Two examples</a></li>
</ul>
</li>
<li><a href="#future-works">Future works</a></li>
<li><a href="#links-to-resources">Links to resources</a></li>
</ul>
</div>
<h2 id="addressing-mode">Addressing mode</h2>
<p>Before we jump into the actual material. I want to briefly revisit the various ways for assembly language
accessing the data in memory (i.e., addressing mode). 
The following table is adapted from CSAPP (2nd edition):</p>
<table class=" table-striped table table-hover">
<thead>
<tr>
<th>Type</th>
<th>Form</th>
<th>Operand Value</th>
<th>Name</th>
</tr>
</thead>
<tbody>
<tr>
<td>Immediate</td>
<td><span class="math">\($Imm\)</span></td>
<td><span class="math">\(Imm\)</span></td>
<td>Immediate</td>
</tr>
<tr>
<td>Register</td>
<td><span class="math">\(E_a\)</span></td>
<td><span class="math">\(R[E_a]\)</span></td>
<td>Register addressing</td>
</tr>
<tr>
<td>Memory</td>
<td><span class="math">\(Imm\)</span></td>
<td><span class="math">\(M[Imm]\)</span></td>
<td>Direct addressing</td>
</tr>
<tr>
<td>Memory</td>
<td><span class="math">\((E_a)\)</span></td>
<td><span class="math">\(M[R[E_b]]\)</span></td>
<td>Indirect addressing</td>
</tr>
<tr>
<td>Memory</td>
<td><span class="math">\(Imm(E_b, E_i, s)\)</span></td>
<td><span class="math">\(M[Imm+R[E_b]+(R[E_i]\cdot s)]\)</span></td>
<td>Scaled indexed addressing <sup id="fnref:1"><a class="footnote-ref" href="#fn:1" rel="footnote">1</a></sup></td>
</tr>
</tbody>
</table>
<p>In the above table, </p>
<ul>
<li><span class="math">\(Imm\)</span> refers to a constant value, e.g. <span class="math">\(\mathtt{0x8048d8e}\)</span> or <span class="math">\(\mathtt{48}\)</span></li>
<li><span class="math">\(E_x\)</span> refers to a register, e.g. <span class="math">\(\mathtt{\%eax}\)</span></li>
<li><span class="math">\(R[E_x]\)</span> refers to the value stored in register <span class="math">\(E_x\)</span></li>
<li><span class="math">\(M[x]\)</span> refers to the value stored at memory address <span class="math">\(x\)</span></li>
</ul>
<h2 id="main-course">Main course</h2>
<p>Now, let's bring our main course onto the table: understanding how function works. I'll
first clear up some terms we will use during the explanation. Then, we'll take a look
at the stack and understand how it supports function calls. Lastly, we'll examine
two assembly programs and understand the whole picture of function calls.</p>
<h3 id="some-terms">Some terms</h3>
<p>Let's first consider what the key elements we need in order to form a function:</p>
<ul>
<li>
<p>function name</p>
<p>A function's name is a symbol that represents the address where the function's code starts. </p>
</li>
<li>
<p>function arguments</p>
<p>A function's arguments (aka. parameters) are the data items that are explicitly given to
the function for processing. For example, in mathematics, there is a <span class="math">\(\sin\)</span> function. If
you were to ask a computer to find the <span class="math">\(\sin (2)\)</span>, <span class="math">\(\sin\)</span> would be the function's name, 
and <span class="math">\(2\)</span> would be the argument (or parameter).</p>
</li>
<li>
<p>local variables</p>
<p>Local variables are data storage that a function uses while processing that
is thrown away when it returns. It's knid of like a scratch pad of paper.
Functions get a new piece of paper every time they are activated, and they have to throw
it away when they are finished processing. </p>
</li>
<li>
<p>return address</p>
<p>The return address is an "invisible" parameter in that it isn't directly used
during the function. The return address is a parameter which tells the function
where to resume executing after the function is completed. This is needed because
functions can be called to do processing from many different parts of our program,
and the function needs to be able to get back to wherever it was called from. 
In most programming languages, this parameter is passed automatically when the function
is called. In assembly language, the <code>call</code> instruction handles passing the return 
address for you, and <code>ret</code> handles using that address to return back to where
you called the function from.</p>
</li>
<li>
<p>return value</p>
<p>The return value is the main method of transferring data back to the main program. 
Most programming languages only allow a sinlge return value for function.</p>
</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The way that the variables are stored and the parameters and return values
are transferred by the computer varies from language to language. This variance
is known as a language's <em>calling convention</em>, because it describes how functions
expect to get and receive data when they are called. In this post, I'll 
follow C programming language calling convention.</p>
</div>
<h3 id="stack">Stack</h3>
<p>Each computer program that runs uses a region of memory called the <strong>stack</strong> to enable functions to work
properly. Machine uses the stack to pass function arguments, to store return information, to save
registers for later restoration, and for local variables.
The portion of the stack allocated for a single function call is called a <strong>stack frame</strong>. In other words,
for each function call, new space (i.e., stack frame) is created on the stack. </p>
<p>The computer's stack lives at the very top addresses of memory. As the name suggests, stack is a stack
data structure with the "top" of the stack growing from the high value addresses towards low values
addresses. We use <span class="math">\(\mathtt{push \text{ } S}\)</span> to push the source onto stack, and we use
<span class="math">\(\mathtt{pop \text{ } D}\)</span> to remove the top value from the stack and place it into a destination
(i.e. a register or memory location). We use the stack register, <span class="math">\(\mathtt{\%esp}\)</span> as a pointer
to the top of the stack, which at the same time, is the top of topmost stack frame.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Pointer here means that the stack register contains an address in memory instead of a regular value.</p>
</div>
<h3 id="two-examples">Two examples</h3>
<h2 id="future-works">Future works</h2>
<ul>
<li>For this post, I assume we work with x86 32-bit processor. It's interesting to further
investigate how the things changed for the 64-bit world.</li>
</ul>
<h2 id="links-to-resources">Links to resources</h2>
<p>Here are some of the resources I found helpful while preparing this article:</p>
<ol>
<li><a href="http://dbp-consulting.com/tutorials/debugging/basicAsmDebuggingGDB.html">Basic Assembler Debugging with GDB by Patrick Horgan</a></li>
<li><a href="https://www.csee.umbc.edu/~cpatel2/links/310/nasm/gdb_help.shtml">Using gdb for Assembly Language Debugging</a></li>
<li><a href="https://cs.brown.edu/courses/cs033/docs/guides/x64_cheatsheet.pdf">x64 Cheat Sheet - Brown CS 33</a></li>
<li><a href="http://savannah.spinellicreations.com/pgubook/ProgrammingGroundUp-1-0-booksize.pdf">Programming from the Ground Up</a> Chapter 3,4</li>
<li><a href="https://www.amazon.com/Computer-Systems-Programmers-Perspective-2nd/dp/0136108040">Computer Systems: A Programmer's Perspective (2nd Edition)</a> Section 3.7</li>
</ol>
<div class="footnote">
<hr/>
<ol>
<li id="fn:1">
<p>For scaled indexed addressing, it actually includes both base pointer addressing mode 
(i.e. <code>movl 4(%eax), %ebx</code>) and indexed addressing mode 
(i.e., <code>movl string_start(, %ecx, 1), %eax</code>). <a class="footnote-backref" href="#fnref:1" rev="footnote" title="Jump back to footnote 1 in the text">↩</a></p>
</li>
</ol>
</div>
<script type="text/javascript">if (!document.getElementById('mathjaxscript_pelican_#%@#$@#')) {
    var align = "center",
        indent = "0em",
        linebreak = "false";

    if (false) {
        align = (screen.width < 768) ? "left" : align;
        indent = (screen.width < 768) ? "0em" : indent;
        linebreak = (screen.width < 768) ? 'true' : linebreak;
    }

    var mathjaxscript = document.createElement('script');
    var location_protocol = (false) ? 'https' : document.location.protocol;
    if (location_protocol !== 'http' && location_protocol !== 'https') location_protocol = 'https:';
    mathjaxscript.id = 'mathjaxscript_pelican_#%@#$@#';
    mathjaxscript.type = 'text/javascript';
    mathjaxscript.src = location_protocol + '//cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML';
    mathjaxscript[(window.opera ? "innerHTML" : "text")] =
        "MathJax.Hub.Config({" +
        "    config: ['CommonHTML.js']," +
        "    TeX: { extensions: ['AMSmath.js','AMSsymbols.js','noErrors.js','noUndefined.js'], equationNumbers: { autoNumber: 'AMS' }, Macros: {} }," +
        "    jax: ['input/TeX','input/MathML','output/CommonHTML']," +
        "    extensions: ['tex2jax.js','mml2jax.js','MathMenu.js','MathZoom.js']," +
        "    displayAlign: '"+ align +"'," +
        "    displayIndent: '"+ indent +"'," +
        "    showMathMenu: true," +
        "    messageStyle: 'normal'," +
        "    tex2jax: { " +
        "        inlineMath: [ ['\\\\(','\\\\)'] ], " +
        "        displayMath: [ ['$$','$$'] ]," +
        "        processEscapes: true," +
        "        preview: 'TeX'," +
        "    }, " +
        "    'HTML-CSS': { " +
        "        styles: { '.MathJax_Display, .MathJax .mo, .MathJax .mi, .MathJax .mn': {color: 'inherit ! important'} }," +
        "        linebreaks: { automatic: "+ linebreak +", width: '90% container' }," +
        "    }, " +
        "}); " +
        "if ('default' !== 'default') {" +
            "MathJax.Hub.Register.StartupHook('HTML-CSS Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax['HTML-CSS'].FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
            "MathJax.Hub.Register.StartupHook('SVG Jax Ready',function () {" +
                "var VARIANT = MathJax.OutputJax.SVG.FONTDATA.VARIANT;" +
                "VARIANT['normal'].fonts.unshift('MathJax_default');" +
                "VARIANT['bold'].fonts.unshift('MathJax_default-bold');" +
                "VARIANT['italic'].fonts.unshift('MathJax_default-italic');" +
                "VARIANT['-tex-mathit'].fonts.unshift('MathJax_default-italic');" +
            "});" +
        "}";
    (document.body || document.getElementsByTagName('head')[0]).appendChild(mathjaxscript);
}
</script></body></html>
        </article>

<!--        <footer>
            <p>This entry is posted in <a href="../../../../../category/programming-languages.html">programming languages</a>.</p>
        </footer>-->

<div class="comments">
    <div id="disqus_thread"></div>
    <script type="text/javascript">
        var disqus_shortname = 'zhu45-org';
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();
    </script>
    <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>

    </div>


<footer class="blog-footer">
    <p class="disclaimer">
        Zeyuan Hu &copy; 2015-2017.
    </p>
</footer>
            </div>
<script>
    var _gaq=[['_setAccount','UA-37565522-2'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
</script>
    </body>
</html>